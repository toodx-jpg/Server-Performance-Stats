#!/bin/bash

# --- Global Configurations ---
set -u # Prevent undefined variables

# --- 1. CPU Usage (Calculated from /proc/stat) ---
get_cpu_usage() {
    echo "CPU Usage:"
    grep 'cpu ' /proc/stat | awk '{usage=($2+$4)*100/($2+$4+$5)} END {printf "Current CPU Load: %.2f%%\n", usage}'
}

# --- 2. Memory Usage (Parsed from /proc/meminfo) ---
get_memory_usage() {
    echo "Memory Usage:"
    local meminfo="/proc/meminfo"
    if [[ -f "$meminfo" ]]; then
        awk '
        /^MemTotal:/ {total=$2} 
        /^MemAvailable:/ {avail=$2} 
        END {used=total-avail; printf "Used: %.0fMB / Total: %.0fMB (%.2f%%)\n", used/1024, total/1024, (used/total)*100}
        ' "$meminfo"
    fi
}

# --- 3. Disk Usage ---
get_disk_usage() {
    echo "Disk Usage:"
    df -h --total | awk '/total/ {printf "Total Partition: %s, Used: %s, Free: %s (%s)\n", $2, $3, $4, $5}'
}

# --- 4. Top 5 CPU Processes ---
get_top_cpu_processes() {
    echo "Top 5 Processes by CPU Usage:"
    ps -eo pid,ppid,cmd,%cpu --sort=-%cpu | head -n 6
}

# --- 5. Top 5 Memory Processes ---
get_top_mem_processes() {
    echo "Top 5 Processes by Memory Usage:"
    ps -eo pid,ppid,cmd,%mem --sort=-%mem | head -n 6
}

# --- 6. System Extra Stats ---
get_extra_stats() {
    echo "System Information:"
    echo "Uptime: $(uptime -p)"
    echo "Load Average: $(cat /proc/loadavg | awk '{print $1, $2, $3}')"
    echo "Logged Users: $(who | wc -l)"
}

# --- Main Execution ---
main() {
    clear
    echo "=========================================="
    echo "      Server Performance Dashboard        "
    echo "=========================================="
    get_cpu_usage
    echo "------------------------------------------"
    get_memory_usage
    echo "------------------------------------------"
    get_disk_usage
    echo "------------------------------------------"
    get_top_cpu_processes
    echo "------------------------------------------"
    get_top_mem_processes
    echo "------------------------------------------"
    get_extra_stats
    echo "=========================================="
}

main "$@"
